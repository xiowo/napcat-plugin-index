name: 拒绝 updateTime 修改

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - 'plugins.v4.json'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  reject:
    name: 检查并关闭 updateTime 变更
    runs-on: ubuntu-latest

    steps:
      - name: Detect updateTime change
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const { owner, repo } = context.repo;

            async function getUpdateTime(targetOwner, targetRepo, ref) {
              const { data } = await github.rest.repos.getContent({
                owner: targetOwner,
                repo: targetRepo,
                path: 'plugins.v4.json',
                ref,
              });
              const content = Buffer.from(data.content, data.encoding || 'base64').toString('utf8');
              const json = JSON.parse(content);
              return json.updateTime;
            }

            let baseTime;
            let headTime;
            try {
              let mergeBaseSha = pr.merge_base_sha;
              if (!mergeBaseSha) {
                const { data: prData } = await github.rest.pulls.get({
                  owner,
                  repo,
                  pull_number: pr.number,
                });
                mergeBaseSha = prData.merge_base_sha;
              }

              if (!mergeBaseSha) {
                try {
                  const { data: compare } = await github.rest.repos.compareCommits({
                    owner,
                    repo,
                    base: pr.base.sha || pr.base.ref,
                    head: `${pr.head.repo.owner.login}:${pr.head.ref}`,
                  });
                  mergeBaseSha = compare.merge_base_commit && compare.merge_base_commit.sha;
                } catch (err) {
                  console.log(`compareCommits failed: ${err.message}`);
                }
              }

              if (!mergeBaseSha) {
                console.log('merge_base_sha not found; fallback to base sha.');
                mergeBaseSha = pr.base.sha || pr.base.ref;
              }

              if (!mergeBaseSha) {
                console.log('base sha not found; skip.');
                return;
              }

              baseTime = await getUpdateTime(
                pr.base.repo.owner.login,
                pr.base.repo.name,
                mergeBaseSha
              );
              headTime = await getUpdateTime(
                pr.head.repo.owner.login,
                pr.head.repo.name,
                pr.head.sha
              );
            } catch (err) {
              console.log(`Failed to read plugins.v4.json: ${err.message}`);
              return;
            }

            if (baseTime === headTime) {
              console.log('updateTime unchanged; skip.');
              return;
            }

            const body = [
              '## ⚠️ updateTime 修改被拒绝',
              '',
              `检测到 updateTime 被修改（base: ${baseTime || '缺失'}, current: ${headTime || '缺失'}）。`,
              '请删除 updateTime 的修改后重新提交。',
              'updateTime 会在 PR 合并后由 CI 自动更新。',
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: pr.number,
              per_page: 100,
            });

            const botComment = comments.find(
              c => c.user.type === 'Bot' && c.body.includes('updateTime 修改被拒绝')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pr.number,
                body,
              });
            }

            await github.rest.pulls.update({
              owner,
              repo,
              pull_number: pr.number,
              state: 'closed',
            });
            console.log('PR closed due to updateTime change.');
